generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  PASSENGER
  OPERATOR
  DRIVER
  ADMIN
}

enum BusType {
  AC_SEATER
  NON_AC_SEATER
  AC_SLEEPER
  NON_AC_SLEEPER
  AC_SEMI_SLEEPER
  LUXURY
}

enum SeatType {
  SEATER
  SLEEPER
  UPPER
  LOWER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED_USER
  CANCELLED_OPERATOR
  COMPLETED
  REFUND_PENDING
  REFUNDED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  WALLET
  UPI
  CARD
  CASH
}

enum TripStatus {
  SCHEDULED
  BOARDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DELAYED
}

enum OperatorStatus {
  PENDING_KYC
  KYC_SUBMITTED
  APPROVED
  REJECTED
  SUSPENDED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum RefundStatus {
  REQUESTED
  APPROVED
  REJECTED
  PROCESSED
}

enum CancellationPolicy {
  FLEXIBLE
  MODERATE
  STRICT
}

// ============================================================
// USER
// ============================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  phone         String?   @unique
  passwordHash  String?
  role          UserRole  @default(PASSENGER)
  isActive      Boolean   @default(true)
  emailVerified DateTime?
  phoneVerified DateTime?
  avatarUrl     String?
  walletBalance Decimal   @default(0) @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  passenger   PassengerProfile?
  operator    Operator?
  driver      Driver?
  admin       AdminProfile?
  sessions    Session[]
  otpRequests OtpRequest[]
  bookings    Booking[]
  reviews     Review[]
  disputes    Dispute[]         @relation("RaisedByUser")
  wallet      WalletTransaction[]

  @@map("users")
}

model PassengerProfile {
  id        String    @id @default(cuid())
  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  gender    String?
  dob       DateTime?
  address   String?

  @@map("passenger_profiles")
}

model AdminProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissions String[]

  @@map("admin_profiles")
}

// ============================================================
// OTP
// ============================================================

model OtpRequest {
  id        String    @id @default(cuid())
  userId    String?
  user      User?     @relation(fields: [userId], references: [id])
  phone     String
  code      String
  expiresAt DateTime
  usedAt    DateTime?
  attempts  Int       @default(0)
  createdAt DateTime  @default(now())

  @@index([phone])
  @@map("otp_requests")
}

// ============================================================
// NEXTAUTH TABLES
// ============================================================

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// OPERATOR
// ============================================================

model Operator {
  id                 String             @id @default(cuid())
  userId             String             @unique
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName        String
  registrationNo     String?            @unique
  gstNumber          String?
  panNumber          String?
  status             OperatorStatus     @default(PENDING_KYC)
  rejectionReason    String?
  approvedAt         DateTime?
  approvedBy         String?
  panDocUrl          String?
  gstDocUrl          String?
  rcDocUrl           String?
  bankProofUrl       String?
  bankAccountNo      String?
  bankIfsc           String?
  bankName           String?
  bankAccountName    String?
  commissionRate     Decimal            @default(10) @db.Decimal(5, 2)
  cancellationPolicy CancellationPolicy @default(MODERATE)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  buses    Bus[]
  routes   Route[]
  drivers  Driver[]
  earnings OperatorEarning[]

  @@map("operators")
}

// ============================================================
// DRIVER
// ============================================================

model Driver {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  operatorId    String
  operator      Operator @relation(fields: [operatorId], references: [id])
  licenseNumber String   @unique
  licenseExpiry DateTime
  licenseDocUrl String?
  isAvailable   Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  trips      Trip[]
  attendance DriverAttendance[]

  @@map("drivers")
}

model DriverAttendance {
  id         String    @id @default(cuid())
  driverId   String
  driver     Driver    @relation(fields: [driverId], references: [id])
  date       DateTime  @db.Date
  checkedIn  Boolean   @default(false)
  checkInAt  DateTime?
  checkOutAt DateTime?
  tripId     String?

  @@unique([driverId, date])
  @@map("driver_attendance")
}

// ============================================================
// BUS
// ============================================================

model Bus {
  id              String    @id @default(cuid())
  operatorId      String
  operator        Operator  @relation(fields: [operatorId], references: [id])
  name            String
  registrationNo  String    @unique
  busType         BusType
  totalSeats      Int
  amenities       String[]
  isActive        Boolean   @default(true)
  layoutConfig    Json?
  imageUrls       String[]
  rcDocUrl        String?
  insuranceDocUrl String?
  insuranceExpiry DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  seats     Seat[]
  schedules Schedule[]

  @@map("buses")
}

// ============================================================
// SEAT
// ============================================================

model Seat {
  id         String   @id @default(cuid())
  busId      String
  bus        Bus      @relation(fields: [busId], references: [id])
  seatNumber String
  seatType   SeatType @default(SEATER)
  row        Int
  column     String
  deck       String   @default("lower")
  isActive   Boolean  @default(true)

  bookingSeats BookingsSeat[]

  @@unique([busId, seatNumber])
  @@map("seats")
}

// ============================================================
// CITY
// ============================================================

model City {
  id       String  @id @default(cuid())
  name     String  @unique
  state    String
  code     String? @unique
  isActive Boolean @default(true)

  fromRoutes Route[]     @relation("FromCity")
  toRoutes   Route[]     @relation("ToCity")
  stops      RouteStop[]

  @@map("cities")
}

// ============================================================
// ROUTE
// ============================================================

model Route {
  id           String   @id @default(cuid())
  operatorId   String
  operator     Operator @relation(fields: [operatorId], references: [id])
  fromCityId   String
  fromCity     City     @relation("FromCity", fields: [fromCityId], references: [id])
  toCityId     String
  toCity       City     @relation("ToCity", fields: [toCityId], references: [id])
  name         String
  distanceKm   Int?
  durationMins Int?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stops     RouteStop[]
  schedules Schedule[]

  @@map("routes")
}

model RouteStop {
  id              String   @id @default(cuid())
  routeId         String
  route           Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
  cityId          String
  city            City     @relation(fields: [cityId], references: [id])
  stopOrder       Int
  stopName        String
  arrivalOffset   Int?
  departureOffset Int?

  @@unique([routeId, stopOrder])
  @@map("route_stops")
}

// ============================================================
// SCHEDULE
// ============================================================

model Schedule {
  id            String   @id @default(cuid())
  routeId       String
  route         Route    @relation(fields: [routeId], references: [id])
  busId         String
  bus           Bus      @relation(fields: [busId], references: [id])
  departureTime DateTime
  arrivalTime   DateTime
  recurrence    String?
  baseFare      Decimal  @db.Decimal(10, 2)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  trips     Trip[]
  fareRules FareRule[]

  @@map("schedules")
}

// ============================================================
// FARE RULE
// ============================================================

model FareRule {
  id         String   @id @default(cuid())
  scheduleId String
  schedule   Schedule @relation(fields: [scheduleId], references: [id])
  seatType   SeatType
  price      Decimal  @db.Decimal(10, 2)
  isActive   Boolean  @default(true)

  @@unique([scheduleId, seatType])
  @@map("fare_rules")
}

// ============================================================
// TRIP
// ============================================================

model Trip {
  id              String     @id @default(cuid())
  scheduleId      String
  schedule        Schedule   @relation(fields: [scheduleId], references: [id])
  driverId        String?
  driver          Driver?    @relation(fields: [driverId], references: [id])
  travelDate      DateTime   @db.Date
  status          TripStatus @default(SCHEDULED)
  actualDeparture DateTime?
  actualArrival   DateTime?
  currentLat      Decimal?   @db.Decimal(10, 7)
  currentLng      Decimal?   @db.Decimal(10, 7)
  lastLocationAt  DateTime?
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  bookings  Booking[]
  seatLocks SeatLock[]

  @@unique([scheduleId, travelDate])
  @@map("trips")
}

// ============================================================
// SEAT LOCK
// ============================================================

model SeatLock {
  id        String   @id @default(cuid())
  tripId    String
  trip      Trip     @relation(fields: [tripId], references: [id])
  seatId    String
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([tripId, seatId])
  @@index([expiresAt])
  @@map("seat_locks")
}

// ============================================================
// BOOKING
// ============================================================

model Booking {
  id                 String        @id @default(cuid())
  userId             String
  user               User          @relation(fields: [userId], references: [id])
  tripId             String
  trip               Trip          @relation(fields: [tripId], references: [id])
  pnr                String        @unique @default(cuid())
  status             BookingStatus @default(PENDING)
  baseFare           Decimal       @db.Decimal(10, 2)
  discount           Decimal       @default(0) @db.Decimal(10, 2)
  gstAmount          Decimal       @default(0) @db.Decimal(10, 2)
  convenienceFee     Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount        Decimal       @db.Decimal(10, 2)
  boardingStopId     String?
  droppingStopId     String?
  cancelledAt        DateTime?
  cancellationReason String?
  qrToken            String        @unique @default(cuid())
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  passengers BookingPassenger[]
  seats      BookingsSeat[]
  payment    Payment?
  refund     Refund?
  review     Review?
  dispute    Dispute?

  @@index([userId])
  @@index([tripId])
  @@map("bookings")
}

model BookingPassenger {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  name      String
  age       Int
  gender    String
  seatId    String

  @@map("booking_passengers")
}

model BookingsSeat {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  seatId    String
  seat      Seat    @relation(fields: [seatId], references: [id])
  tripId    String

  @@unique([tripId, seatId])
  @@map("bookings_seats")
}

// ============================================================
// PAYMENT
// ============================================================

model Payment {
  id              String        @id @default(cuid())
  bookingId       String        @unique
  booking         Booking       @relation(fields: [bookingId], references: [id])
  amount          Decimal       @db.Decimal(10, 2)
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  gatewayTxnId    String?
  gatewayResponse Json?
  initiatedAt     DateTime      @default(now())
  completedAt     DateTime?

  @@map("payments")
}

// ============================================================
// REFUND
// ============================================================

model Refund {
  id              String       @id @default(cuid())
  bookingId       String       @unique
  booking         Booking      @relation(fields: [bookingId], references: [id])
  requestedAt     DateTime     @default(now())
  requestedBy     String
  amount          Decimal      @db.Decimal(10, 2)
  reason          String?
  status          RefundStatus @default(REQUESTED)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  processedAt     DateTime?
  refundTxnId     String?

  @@map("refunds")
}

// ============================================================
// REVIEW
// ============================================================

model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique
  booking   Booking  @relation(fields: [bookingId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  rating    Int
  comment   String?
  tags      String[]
  isVisible Boolean  @default(true)
  createdAt DateTime @default(now())

  @@map("reviews")
}

// ============================================================
// DISPUTE
// ============================================================

model Dispute {
  id          String        @id @default(cuid())
  bookingId   String        @unique
  booking     Booking       @relation(fields: [bookingId], references: [id])
  raisedBy    String
  user        User          @relation("RaisedByUser", fields: [raisedBy], references: [id])
  reason      String
  description String?
  status      DisputeStatus @default(OPEN)
  assignedTo  String?
  resolution  String?
  resolvedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("disputes")
}

// ============================================================
// OPERATOR EARNING
// ============================================================

model OperatorEarning {
  id              String   @id @default(cuid())
  operatorId      String
  operator        Operator @relation(fields: [operatorId], references: [id])
  bookingId       String   @unique
  tripDate        DateTime @db.Date
  grossAmount     Decimal  @db.Decimal(10, 2)
  commissionRate  Decimal  @db.Decimal(5, 2)
  commissionAmt   Decimal  @db.Decimal(10, 2)
  gstOnCommission Decimal  @db.Decimal(10, 2)
  netPayout       Decimal  @db.Decimal(10, 2)
  settledAt       DateTime?
  createdAt       DateTime @default(now())

  @@index([operatorId])
  @@map("operator_earnings")
}

// ============================================================
// WALLET TRANSACTION
// ============================================================

model WalletTransaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        String
  amount      Decimal  @db.Decimal(10, 2)
  description String
  refBooking  String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("wallet_transactions")
}

// ============================================================
// COMMISSION RULE
// ============================================================

model CommissionRule {
  id            String   @id @default(cuid())
  name          String
  minCommission Decimal  @default(5) @db.Decimal(5, 2)
  maxCommission Decimal  @default(15) @db.Decimal(5, 2)
  defaultRate   Decimal  @default(10) @db.Decimal(5, 2)
  gstRate       Decimal  @default(18) @db.Decimal(5, 2)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("commission_rules")
}
